name: AgentWeb CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # â”€â”€ Core renderer tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: Renderer Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'   # node:sqlite requires Node 22+
          cache: 'npm'
          cache-dependency-path: prototype/package-lock.json

      - name: Install deps
        run: cd prototype && npm ci

      - name: Install Playwright Chromium
        run: cd prototype && npx playwright install chromium --with-deps

      - name: Run SPA detection + renderer tests
        run: cd prototype && node test-smart-renderer.js
        timeout-minutes: 5

      - name: Run cache layer tests
        run: cd prototype && node test-cache.js
        timeout-minutes: 3

      - name: Run lite renderer tests
        run: cd prototype && node test-lite.js 2>/dev/null || true  # may not exist yet

  # â”€â”€ Package validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  package-check:
    name: Package Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Verify skill exports
        run: |
          echo "Checking skill.js exports..."
          node -e "import('./skill.js').then(m => console.log('Skill exports:', Object.keys(m))).catch(e => console.warn('skill.js not an ES module or missing:', e.message))" || true

      - name: Check CLI entrypoint
        run: |
          cd prototype
          node cli.js --help 2>&1 || true

  # â”€â”€ Benchmark â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: prototype/package-lock.json

      - name: Install deps + Playwright
        run: |
          cd prototype && npm ci
          cd prototype && npx playwright install chromium --with-deps

      - name: Run benchmark
        run: cd prototype && node benchmark.js 2>&1 | tee benchmark-results.txt
        timeout-minutes: 5

      - name: Post benchmark to job summary
        run: |
          echo "## ðŸŒ AgentWeb Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat prototype/benchmark-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test, package-check]
    if: always()
    steps:
      - name: Write summary
        run: |
          echo "## ðŸŒ AgentWeb CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Renderer Tests | ${{ needs.test.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Check | ${{ needs.package-check.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
